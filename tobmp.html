<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMPå›¾ç‰‡æ‰¹é‡åˆæˆå·¥å…·ï¼ˆä¿®å¤å¤±çœŸç‰ˆï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-area {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 4px;
        }
        button {
            background: #0078d7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #005a9e;
        }
        #status {
            margin-top: 20px;
            color: #333;
            font-weight: 500;
        }
        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            display: none;
        }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BMPå›¾ç‰‡æ‰¹é‡åˆæˆå·¥å…·ï¼ˆä¿®å¤å¤±çœŸç‰ˆï¼‰</h1>
        
        <div class="input-area">
            <h3>æ­¥éª¤1ï¼šé€‰æ‹©åº•å›¾ï¼ˆå›¾ç‰‡Aï¼‰</h3>
            <input type="file" id="baseImageInput" accept=".bmp,.BMP">
        </div>

        <div class="input-area">
            <h3>æ­¥éª¤2ï¼šé€‰æ‹©æ–‡ä»¶å¤¹Bï¼ˆä»…è¯»å–å½“å‰æ–‡ä»¶å¤¹çš„BMPï¼‰</h3>
            <input type="file" id="folderInput" webkitdirectory directory multiple accept=".bmp,.BMP">
            <p style="color: #666; font-size: 14px;">æç¤ºï¼šä»…è¯»å–æ‰€é€‰æ–‡ä»¶å¤¹<u>ç›´æ¥ç›®å½•</u>ä¸‹çš„.bmp/.BMPæ–‡ä»¶ï¼Œä¸åŒ…å«å­æ–‡ä»¶å¤¹</p>
            <div class="debug-info" id="debugInfo">
                <p><strong>è¯»å–åˆ°çš„æ‰€æœ‰æ–‡ä»¶ï¼š</strong><span id="allFiles"></span></p>
                <p><strong>ç­›é€‰åçš„BMPæ–‡ä»¶ï¼š</strong><span id="filteredFiles"></span></p>
            </div>
            <button type="button" onclick="document.getElementById('debugInfo').style.display='block'">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        </div>

        <button id="mergeBtn">å¼€å§‹æ‰¹é‡åˆæˆå¹¶ä¸‹è½½</button>
        <div id="status"></div>
    </div>

    <script>
        let baseImage = null;
        let folderImages = [];

        // ç›‘å¬åº•å›¾é€‰æ‹©
        document.getElementById('baseImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!/\.bmp$/i.test(file.name)) {
                alert('è¯·é€‰æ‹©BMPæ ¼å¼çš„åº•å›¾ï¼ˆåç¼€ä¸º.bmp/.BMPï¼‰ï¼');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    baseImage = img;
                    document.getElementById('status').innerText = `âœ… å·²åŠ è½½åº•å›¾ï¼š${file.name}ï¼ˆå°ºå¯¸ï¼š${img.width}x${img.height}ï¼‰`;
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // ç›‘å¬æ–‡ä»¶å¤¹é€‰æ‹©
        document.getElementById('folderInput').addEventListener('change', function(e) {
            const allFiles = Array.from(e.target.files);
            document.getElementById('allFiles').innerText = allFiles.map(f => `${f.name}ï¼ˆè·¯å¾„ï¼š${f.webkitRelativePath}ï¼‰`).join(' | ');
            
            folderImages = allFiles.filter(file => {
                const relativePath = file.webkitRelativePath || file.name;
                const slashCount = (relativePath.match(/\//g) || []).length;
                const isRootFile = slashCount <= 1;
                const isBmpFile = /\.bmp$/i.test(file.name);
                return isRootFile && isBmpFile;
            });

            document.getElementById('filteredFiles').innerText = folderImages.map(f => f.name).join(' | ') || 'æ— ';
            document.getElementById('status').innerText = 
                `âœ… å…±è¯»å–åˆ° ${allFiles.length} ä¸ªæ–‡ä»¶ï¼Œç­›é€‰å‡º ${folderImages.length} ä¸ªå½“å‰æ–‡ä»¶å¤¹çš„BMPæ–‡ä»¶`;
        });

        // æ‰¹é‡åˆæˆé€»è¾‘
        document.getElementById('mergeBtn').addEventListener('click', async function() {
            if (!baseImage) {
                alert('è¯·å…ˆé€‰æ‹©åº•å›¾Aï¼');
                return;
            }
            if (folderImages.length === 0) {
                alert('æœªç­›é€‰åˆ°æœ‰æ•ˆBMPæ–‡ä»¶ï¼è¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶æ˜¯å¦åœ¨æ‰€é€‰æ–‡ä»¶å¤¹çš„ç›´æ¥ç›®å½•ä¸‹\n2. æ–‡ä»¶åç¼€æ˜¯å¦ä¸º.bmp/.BMP');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerText = 'åˆæˆä¸­...';
            document.getElementById('status').innerText = `å¼€å§‹åˆæˆï¼Œå…±${folderImages.length}å¼ å›¾ç‰‡ï¼Œè¯·ç¨å€™...`;

            try {
                for (let i = 0; i < folderImages.length; i++) {
                    const file = folderImages[i];
                    const layerImg = await loadImage(file);
                    const mergedBlob = await mergeImages(baseImage, layerImg);
                    downloadBlob(mergedBlob, `${file.name}`);
                    document.getElementById('status').innerText = `âœ… å·²å®Œæˆ ${i+1}/${folderImages.length}ï¼š${file.name}`;
                }
                document.getElementById('status').innerText = `ğŸ‰ åˆæˆå®Œæˆï¼å…±ç”Ÿæˆ ${folderImages.length} å¼ 8ä½BMPå›¾ç‰‡ï¼Œå·²è‡ªåŠ¨ä¸‹è½½`;
            } catch (error) {
                document.getElementById('status').innerText = `âŒ åˆæˆå¤±è´¥ï¼š${error.message}`;
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.innerText = 'å¼€å§‹æ‰¹é‡åˆæˆå¹¶ä¸‹è½½';
            }
        });

        // åŠ è½½å›¾ç‰‡
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = (err) => reject(new Error(`åŠ è½½å›¾ç‰‡${file.name}å¤±è´¥ï¼š${err}`));
                    img.src = event.target.result;
                }
                reader.onerror = (err) => reject(new Error(`è¯»å–å›¾ç‰‡${file.name}å¤±è´¥ï¼š${err}`));
                reader.readAsDataURL(file);
            });
        }

        // åˆæˆå›¾ç‰‡ï¼ˆä¿®å¤å¤±çœŸï¼‰
        function mergeImages(baseImg, layerImg) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = baseImg.width;
                canvas.height = baseImg.height;
                const ctx = canvas.getContext('2d');

                // ç»˜åˆ¶åº•å›¾+å±…ä¸­å›¾å±‚
                ctx.drawImage(baseImg, 0, 0);
                const x = (canvas.width - layerImg.width) / 2;
                const y = (canvas.height - layerImg.height) / 2;
                ctx.drawImage(layerImg, x, y);

                // è½¬ä¸º8ä½BMP
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const bmpData = create8BitBMP(imageData);
                const bmpBlob = new Blob([bmpData], { type: 'image/bmp' });
                resolve(bmpBlob);
            });
        }

        // ä¿®å¤åçš„8ä½BMPç”Ÿæˆå‡½æ•°
        function create8BitBMP(imageData) {
            const { width, height, data } = imageData;
            const colorMap = new Map();
            const colors = [];
            // ç¬¬ä¸€æ­¥ï¼šå…ˆç»Ÿè®¡æ‰€æœ‰é¢œè‰²ï¼Œè¶…è¿‡256è‰²æ—¶åšç®€å•é‡åŒ–ï¼ˆå–å‰256ç§+å…œåº•ï¼‰
            for (let i = 0; i < data.length; i += 4) {
                // å¿½ç•¥é€æ˜é€šé“ï¼ˆ8ä½BMPä¸æ”¯æŒé€æ˜ï¼‰
                const r = data[i], g = data[i+1], b = data[i+2];
                const colorKey = `${r},${g},${b}`;
                // ä»…ä¿ç•™å‰256ç§é¢œè‰²
                if (!colorMap.has(colorKey) && colors.length < 256) {
                    colorMap.set(colorKey, colors.length);
                    colors.push({ r, g, b });
                }
            }

            // ç¬¬äºŒæ­¥ï¼šæ­£ç¡®ç”Ÿæˆåƒç´ ç´¢å¼•ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
            const pixelIndices = [];
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const colorKey = `${r},${g},${b}`;
                // æ‰¾ä¸åˆ°çš„é¢œè‰²æ˜ å°„åˆ°æœ€æ¥è¿‘çš„å·²æœ‰é¢œè‰²ï¼ˆæ›¿ä»£åŸæœ‰çš„||0ï¼‰
                const index = colorMap.get(colorKey) || findClosestColor({r,g,b}, colors);
                pixelIndices.push(index);
            }

            // BMPæ–‡ä»¶å¤´
            const fileHeader = new Uint8Array([0x42,0x4D,0,0,0,0,0,0,0,0,14+40+256*4,0,0,0]);
            // BMPä¿¡æ¯å¤´ï¼ˆä¿®æ­£é«˜åº¦ä¸ºæ­£ï¼ŒBMPé»˜è®¤å€’åºå­˜å‚¨ï¼‰
            const infoHeader = new Uint8Array([
                40,0,0,0, // ä¿¡æ¯å¤´å¤§å°
                width&0xff,(width>>8)&0xff,(width>>16)&0xff,(width>>24)&0xff, // å®½åº¦
                height&0xff,(height>>8)&0xff,(height>>16)&0xff,(height>>24)&0xff, // é«˜åº¦ï¼ˆæ­£æ•°ï¼Œåç»­å€’åºå†™å…¥åƒç´ ï¼‰
                1,0, // å¹³é¢æ•°
                8,0, // 8ä½è‰²æ·±
                0,0,0,0, // æ— å‹ç¼©
                0,0,0,0, // åƒç´ æ•°æ®å¤§å°ï¼ˆåç»­è®¡ç®—ï¼‰
                2835,0,0,0, // æ°´å¹³åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ï¼‰
                2835,0,0,0, // å‚ç›´åˆ†è¾¨ç‡ï¼ˆé»˜è®¤ï¼‰
                256,0,0,0, // è°ƒè‰²æ¿é¢œè‰²æ•°
                0,0,0,0  // é‡è¦é¢œè‰²æ•°
            ]);

            // ç¬¬ä¸‰æ­¥ï¼šä¿®å¤è°ƒè‰²æ¿ï¼ˆç¡®ä¿ç©ºä½ç½®ä¸ºé»‘è‰²ï¼Œé¿å…çº¢è‰²ï¼‰
            const palette = new Uint8Array(256*4);
            for (let i=0; i<256; i++) {
                const c = colors[i] || {r:0, g:0, b:0}; // ç©ºä½ç½®å¼ºåˆ¶é»‘è‰²
                palette[i*4] = c.b;     // B
                palette[i*4+1] = c.g;   // G
                palette[i*4+2] = c.r;   // R
                palette[i*4+3] = 0;     // ä¿ç•™ä½
            }

            // ç¬¬å››æ­¥ï¼šæ­£ç¡®å†™å…¥åƒç´ æ•°æ®ï¼ˆä»ä¸‹åˆ°ä¸Šï¼Œ4å­—èŠ‚å¯¹é½ï¼‰
            const rowSize = Math.floor((8*width +31)/32)*4; // æ¯è¡Œå­—èŠ‚æ•°ï¼ˆ4å­—èŠ‚å¯¹é½ï¼‰
            const pixelData = new Uint8Array(rowSize*height);
            let ptr = 0;
            // BMPåƒç´ å­˜å‚¨æ˜¯ä»ä¸‹åˆ°ä¸Šï¼Œæ‰€ä»¥åå‘éå†yè½´
            for (let y = height - 1; y >= 0; y--) {
                for (let x = 0; x < width; x++) {
                    // å–å¯¹åº”ä½ç½®çš„ç´¢å¼•ï¼ˆyæ˜¯åå‘çš„ï¼Œxæ˜¯æ­£å‘çš„ï¼‰
                    const pixelIndex = y * width + x;
                    pixelData[ptr++] = pixelIndices[pixelIndex];
                }
                // è¡¥å…¨4å­—èŠ‚å¯¹é½
                while (ptr % 4 !== 0) {
                    pixelData[ptr++] = 0;
                }
            }

            // è®¡ç®—æ€»å¤§å°å¹¶å¡«å……æ–‡ä»¶å¤´
            const pixelDataSize = pixelData.length;
            const totalSize = 14 + 40 + 256*4 + pixelDataSize;
            fileHeader[2] = totalSize & 0xff;
            fileHeader[3] = (totalSize >> 8) & 0xff;
            fileHeader[4] = (totalSize >> 16) & 0xff;
            fileHeader[5] = (totalSize >> 24) & 0xff;
            // å¡«å……åƒç´ æ•°æ®å¤§å°
            infoHeader[20] = pixelDataSize & 0xff;
            infoHeader[21] = (pixelDataSize >> 8) & 0xff;
            infoHeader[22] = (pixelDataSize >> 16) & 0xff;
            infoHeader[23] = (pixelDataSize >> 24) & 0xff;

            // åˆå¹¶æ‰€æœ‰æ•°æ®
            const bmpArray = new Uint8Array(totalSize);
            let offset = 0;
            bmpArray.set(fileHeader, offset); offset += 14;
            bmpArray.set(infoHeader, offset); offset += 40;
            bmpArray.set(palette, offset); offset += 256*4;
            bmpArray.set(pixelData, offset);

            return bmpArray;
        }

        // è¾…åŠ©å‡½æ•°ï¼šå¯»æ‰¾æœ€æ¥è¿‘çš„é¢œè‰²ï¼ˆé¿å…é¢œè‰²ä¸¢å¤±åç›´æ¥å˜çº¢ï¼‰
        function findClosestColor(target, colorList) {
            if (colorList.length === 0) return 0; // å…œåº•è¿”å›é»‘è‰²
            let closestIndex = 0;
            let minDistance = Infinity;
            for (let i = 0; i < colorList.length; i++) {
                const c = colorList[i];
                // è®¡ç®—RGBæ¬§æ°è·ç¦»
                const distance = Math.sqrt(
                    Math.pow(target.r - c.r, 2) +
                    Math.pow(target.g - c.g, 2) +
                    Math.pow(target.b - c.b, 2)
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            }
            return closestIndex;
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
